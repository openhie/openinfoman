<csd:careServicesFunction xmlns:csd="urn:ihe:iti:csd:2013" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:hfp="http://www.w3.org/2001/XMLSchema-hasFacetAndProperty" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:ev="http://www.w3.org/2001/xml-events" urn="urn:openhie.org:openinfoman:mark_potential_duplicate" content-type="text/xml">
  <csd:description> 
    Marks a record as a potential duplicate with another record.  This is done by adding a <b>&lt;csd:otherID/&gt;</b> element to the record that is the potential duplicate which references the master record.  
    
    This a <b>&lt;csd:otherID/&gt;</b> is characterized as follows:
    <ul>
      <li>The <b>@assigningAuthorityName</b> attribute will be the fixed value<b>urn:openhie.org:openinfoman</b> attribute of the master record</li>      
      <li>The <b>@code</b> attribute will be the fixed value 'potential-duplicate' to indicate this is for marking a potential duplicate</li>
      <li>The <b>text()</b> value will be the entity ID used to reference to the master record for the entity</li>
    </ul>

    A Care Services Request can be submitted to mark the record as potential duplicate with the following request parameters (under a &lt;csd:requestParams/&gt; element):
    <ul>
      <li>
        <b>&lt;masterEntity/&gt;</b> should have attribute <b>@entityID</b> which contains the entity ID of the master record that the potential duplicate record should refer to</li>
      <li>
        <b>&lt;duplicateEntity/&gt;</b> should have attribute <b>@entityID</b> which contains the entity ID of the  duplicate record</li>
    </ul>

  </csd:description>
  <csd:definition>
    <xi:include parse="text" href="mark_potential_duplicate.xq"/>
  </csd:definition>
  <xforms:model id="urn:openhie.org:openinfoman:mark_potential_duplicate">
    <xforms:instance id="care-services-result">
      <csd:careSerivcesResponse id="" code="" content-type=""/>
    </xforms:instance>
    <xforms:instance id="http-post-request">
      <csd:requestParams>
	<masterEntity/>
	<duplicateEntity/>
      </csd:requestParams>
    </xforms:instance>
    <xforms:instance id="http-post-response">
      <http:result xmlns:http="http://expath.org/ns/http-client" status="">
        <http:header name="X-CSD-Transaction-ID" value=""/>
        <http:body/>
      </http:result>
    </xforms:instance>
    <xforms:instance id="soap-request">
      <soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope">
        <soap:Header>
          <wsa:Action xmlns:wsa="http://www.w3.org/2005/08/addressing" soap:mustUnderstand="1">urn:ihe:iti:csd:2013:GetCareServicesRequest</wsa:Action>
          <wsa:MessageID xmlns:wsa="http://www.w3.org/2005/08/addressing"/>
          <wsa:ReplyTo xmlns:wsa="http://www.w3.org/2005/08/addressing" soap:mustUnderstand="1">
            <wsa:Address>http://www.w3.org/2005/08/addressing/anonymous</wsa:Address>
          </wsa:ReplyTo>
          <wsa:To xmlns:wsa="http://www.w3.org/2005/08/addressing" soap:mustUnderstand="1">{$LOCATION}</wsa:To>
        </soap:Header>
        <soap:Body>
          <csd:careServicesRequest urn="urn:openhie.org:openinfoman:mark_potential_duplicate">
	    <csd:requestParams>
	      <masterEntity/>
	      <duplicateEntity/>
	    </csd:requestParams>
          </csd:careServicesRequest>
        </soap:Body>
      </soap:Envelope>
    </xforms:instance>
    <xforms:instance id="soap-response">
      <soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope">
        <soap:Header>
          <wsa:Action xmlns:wsa="http://www.w3.org/2005/08/addressing" soap:mustUnderstand="1">urn:ihe:iti:csd:2013:GetCareServicesResponse</wsa:Action>
          <wsa:MessageID xmlns:wsa="http://www.w3.org/2005/08/addressing"/>
          <wsa:ReplyTo xmlns:wsa="http://www.w3.org/2005/08/addressing" soap:mustUnderstand="1">
            <wsa:Address>http://www.w3.org/2005/08/addressing/anonymous</wsa:Address>
          </wsa:ReplyTo>
          <wsa:RelatesTo xmlns:wsa="http://www.w3.org/2005/08/addressing"/>
        </soap:Header>
        <soap:Body>
          <csd:careServicesResponse/>
        </soap:Body>
      </soap:Envelope>
    </xforms:instance>
    <xforms:submission id="soap-submission" method="post" mediatype="application/soap+xml" ref="instance('soap-request')" resource="{$LOCATION}"/>
    <xforms:submission id="http-post-submission" method="post" mediatype="text/xml" ref="instance('http-post-request')" resource="{$LOCATION}/urn:openhie.org:openinfoman:mark_potential_duplicate"/>
    <xforms:action ev:event="xforms-submit-done" id="http-post-prepare">
      <xforms:insert context="instance('http-post-response')/http:result/http:body" origin="instance('care-services-result')/csd:careServicesResponse/csd:result/*"/>
      <xforms:setValue bind="instance('http-post-response')/http:result/@status" value="instance('care-services-result')/csd:careServicesResponse/@code"/>
      <xforms:setValue bind="instance('http-post-response')/http:body/@content-type" value="instance('care-services-result')/csd:careServicesResponse/@content-type"/>
      <xforms:setValue bind="instance('http-post-response')/http:result/http:header[@name='X-CSD-Transaction-ID']/@value" value="instance('care-services-result')/csd:careServicesResponse/@id"/>
    </xforms:action>
    <xforms:action ev:event="xforms-submit-done" id="soap-prepare">
      <xforms:insert context="instance('soap-response')/soap:Envelope/soap:Body/csd:careServicesResponse/csd:result" origin="instance('care-services-result')/csd:careServicesRepsonse/csd:result/*"/>
      <xforms:insert context="instance('soap-response')/soap:Envelope/soap:Body/csd:careServicesResponse/@content-type" origin="instance('care-services-result')/csd:careServicesRepsonse/@content-type"/>
      <xforms:insert context="instance('soap-response')/soap:Envelope/soap:Body/csd:careServicesResponse/@code" origin="instance('care-services-result')/csd:careServicesRepsonse/@code"/>
      <xforms:setValue bind="instance('soap-response')/soap:Envelope/soap:Header/wsa:messageID" value="instance('soap-request')/csd:careServicesRequest/@id"/>
      <xforms:setValue bind="instance('soap-response')/soap:Envelope/soap:Header/wsa:relatesTo" value="instance('soap-request')/soap:Envelope/soap:Header/wsa:messageID"/>
    </xforms:action>
  </xforms:model>
  

</csd:careServicesFunction>